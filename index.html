<!doctype html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <title></title>
    <meta name="description" content="">
    <meta name="author" content="">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="css/style.css" rel="stylesheet">
    <link href="css/m-styles.min.css" rel="stylesheet">
    <style>

    </style>
</head>

<body>
    <div id="container">
        <div id="left">
            <div id="player_container">
                <img src="img/album.jpg" id="album_art" />
                <div id="now_playing_container">
                    <p id="title"></p>
                    <p id="artist"></p>
                    <p id="album"></p>
                </div>
                <div id="playlist" class="ui-sortable ui-droppable"></div>
                <div id="player_controls">
                    <div class="m-btn-group">
                        <a href="#" class="m-btn icn-only"><i class="icon-backward"></i></a>
                        <a href="#" class="m-btn icn-only"><i class="icon-play"></i></a>
                        <a href="#" class="m-btn icn-only"><i class="icon-stop"></i></a>
                        <a href="#" class="m-btn icn-only"><i class="icon-forward"></i></a>
                        <a href="#" class="m-btn icn-only"><i class="icon-volume-off"></i></a>
                        <a href="#" class="m-btn icn-only"><i class="icon-repeat"></i></a>
                    </div>
                    <audio id="player" controls onended="playlist_next()" src=""></audio>
                </div>
            </div>
        </div>
        <div id="right">
            <div id="menu_bar">
                <div class="m-btn-group toggle-buttons panels">
                    <a href="#" class="m-btn active">Library</a>
                    <a href="#" class="m-btn">Playlists</a>
                    <a href="#" class="m-btn">Search</a>
                    <a href="#" class="m-btn">Preferences</a>
                </div>

                <div class="m-btn-group">
                    <a href="#" class="m-btn"><i class="icon-random"></i> Random Album</a>
                </div>

                <!--<input type='text' id='search' />-->
            </div>
            <div id="file_browser" class="main_window" role="main"></div>
            <div id="playlist_browser" class="main_window" style="display:none;"></div>
            <div id="search_browser" class="main_window" style="display:none;"></div>
            <div id="settings_browser" class="main_window" style="display:none;"></div>
            <div id="file_info"></div>
        </div>
    </div>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.3.3/underscore-min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/backbone.js/0.9.2/backbone-min.js">
    </script>
    <script src="js/libs/deep-model.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/backbone.modelbinder/0.1.5/Backbone.ModelBinder.min.js"></script>

    <script src="js/bootstrap.js"></script>
    <script>window.jQuery || document.write('<script src="js/libs/jquery-1.7.2.min.js"><\/script>')</script>

    <script type="text/template" id="list_row_template">
        <a class="m-btn mini list_row_item" style="width:100%; text-align:left;">
            <i bind="type"></i>
            <span bind="name"></span>
        </a>
        <div bind="id" style="margin-left:10px;"></div>
    </script>

    <script type="text/template" id="list_template">
        <div id="list"></div>
    </script>

    <script type="text/javascript">
        $(document).ready(function() {

            window.music = {};
            music.templates = {}
            music.prototypes = {};
            music.models = {};
            music.collections = {};
            music.views = {};

            music.prototypes.File = Backbone.DeepModel.extend({
                urlRoot: 'api/list_dir/',
            });

            music.prototypes.Files = Backbone.Collection.extend({
                model: music.prototypes.File,
                url: 'api/list_dir/',
                comparator: function(model) {
                    return model.get('name');
                }
            });

            music.prototypes.FileView = Backbone.View.extend({
                template: _.template($(list_row_template).html()),
                events: {
                    'click a.list_row_item': 'click'
                },
                initialize: function() {
                    this.render();
                    this.modelBinder = new Backbone.ModelBinder();
                    var bindings = Backbone.ModelBinder.createDefaultBindings(this.el, 'bind');
                    bindings = _.extend(bindings, {
                      type: [
                        {
                          selector: '[bind=type]',
                          elAttribute: 'class',
                          converter: function(direction, type) {
                            if (type === "directory") {
                                return "icon-folder-close";
                            } else {
                                return "icon-music";
                            }
                          }
                        },
                        {
                            selector: '[bind=name]',
                            elAttribute: 'text'
                        },
                      ],
                      id: [
                        {
                            selector: '[bind=id]',
                            elAttribute: 'id',
                            converter: function(direction, id) {
                                return id.replace('=', '');
                            }
                        }
                      ]
                    });
                    this.modelBinder.bind(this.model, this.el, bindings);
                },
                render: function() {
                    this.$el.html(this.template(this.model.toJSON()));
                },
                click: function() {
                    console.log('you clicked ' + this.model.get('name'));
                    var self = this;
                    if (this.model.get('type') === "directory") {
                        var el = self.model.id.replace('=', '');
                        if (this.model.get("open")) {
                            $('#' + el).html('').hide();
                            this.model.unset('open');
                        } else {
                            this.model.fetch({
                                success: function(model) {
                                    var x = new music.prototypes.ListView({
                                        collection: new music.prototypes.Files(model.get('files')),
                                        parent: self,
                                        el: $('#' + el),
                                    });
                                    self.model.set('open', 1);
                                    $('#' + el).show();
                                }
                            });
                        }
                    } else {
                        console.log("playing song", this.model.get('path'));
                    }
                }
            });

            music.prototypes['ListView'] = Backbone.View.extend({
                template: _.template($(list_template).html()),
                initialize: function() {
                    this.collection.bind('add', this.add, this);
                    this.collection.bind('reset', this.render, this);
                    this.render();
                },
                render: function() {
                    this.$el.html(this.template());
                    var self = this;
                    this.collection.each(function(account){
                        self.add(account);
                    });
                },
                add: function(file) {
                    music.views[file.get('id')] = new music.prototypes.FileView({
                        model: file,
                        parent: this,
                    });
                    this.$el.append(music.views[file.get('id')].el);
                }
            });

            $.getJSON('api/list_dir/', function(data) {
                music.collections.files = new music.prototypes.Files();

                music.views['listView'] = new music.prototypes.ListView({
                    el: $('div[role="main"]'),
                    collection: music.collections.files,
                    parent: this
                });

                music.collections.files.reset(data.files);
                //music.collections.files.sort();

            });

        })
    </script>
</body>
</html>
